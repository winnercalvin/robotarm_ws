# tacobot/drizzle_tools_blend_radius.py
import math
import time

# =====================================================================
# 🌟 [숨겨둔 좌표] 웹소켓 draw_path가 없을 때 사용할 기본 도안
# =====================================================================
DEFAULT_DRAWING_COORDS = [
  [0.110, 0.244], [0.152, 0.216], [0.175, 0.199], [0.187, 0.191], [0.197, 0.186],
  [0.205, 0.179], [0.215, 0.174], [0.225, 0.168], [0.233, 0.163], [0.243, 0.158],
  [0.252, 0.152], [0.260, 0.147], [0.270, 0.142], [0.278, 0.138], [0.288, 0.134],
  [0.297, 0.129], [0.305, 0.126], [0.310, 0.124], [0.315, 0.122], [0.320, 0.121],
  [0.325, 0.119], [0.328, 0.119], [0.332, 0.119], [0.333, 0.119], [0.335, 0.119],
  [0.337, 0.119], [0.337, 0.121], [0.338, 0.122], [0.338, 0.126], [0.338, 0.128],
  [0.338, 0.133], [0.338, 0.139], [0.335, 0.146], [0.332, 0.154], [0.327, 0.163],
  [0.320, 0.172], [0.312, 0.184], [0.305, 0.196], [0.295, 0.207], [0.287, 0.221],
  [0.275, 0.236], [0.265, 0.251], [0.255, 0.266], [0.245, 0.281], [0.237, 0.296],
  [0.227, 0.311], [0.218, 0.326], [0.208, 0.339], [0.200, 0.354], [0.192, 0.367],
  [0.183, 0.383], [0.177, 0.396], [0.170, 0.409], [0.163, 0.421], [0.157, 0.431],
  [0.152, 0.443], [0.147, 0.451], [0.142, 0.459], [0.138, 0.468], [0.137, 0.472],
  [0.135, 0.477], [0.135, 0.481], [0.135, 0.482], [0.137, 0.482], [0.137, 0.482],
  [0.137, 0.481], [0.138, 0.479], [0.142, 0.476], [0.145, 0.471], [0.152, 0.464],
  [0.158, 0.456], [0.168, 0.446], [0.180, 0.434], [0.192, 0.422], [0.207, 0.409],
  [0.222, 0.394], [0.238, 0.381], [0.253, 0.366], [0.270, 0.351], [0.290, 0.336],
  [0.307, 0.323], [0.325, 0.307], [0.343, 0.292], [0.362, 0.279], [0.377, 0.266],
  [0.393, 0.254], [0.410, 0.241], [0.427, 0.229], [0.442, 0.217], [0.455, 0.207],
  [0.468, 0.198], [0.482, 0.188], [0.493, 0.179], [0.503, 0.171], [0.515, 0.164],
  [0.523, 0.158], [0.533, 0.151], [0.542, 0.146], [0.550, 0.141], [0.557, 0.136],
  [0.562, 0.133], [0.565, 0.131], [0.567, 0.129], [0.568, 0.129], [0.570, 0.129],
  [0.572, 0.129], [0.573, 0.129], [0.573, 0.129], [0.572, 0.131], [0.572, 0.133],
  [0.572, 0.134], [0.572, 0.139], [0.572, 0.144], [0.570, 0.149], [0.565, 0.158],
  [0.558, 0.168], [0.548, 0.179], [0.538, 0.193], [0.525, 0.207], [0.510, 0.226],
  [0.493, 0.244], [0.475, 0.266], [0.455, 0.286], [0.435, 0.307], [0.415, 0.331],
  [0.393, 0.354], [0.377, 0.376], [0.358, 0.401], [0.340, 0.424], [0.322, 0.448],
  [0.303, 0.472], [0.287, 0.496], [0.268, 0.517], [0.253, 0.541], [0.237, 0.563],
  [0.222, 0.583], [0.208, 0.603], [0.197, 0.621], [0.188, 0.637], [0.180, 0.651],
  [0.173, 0.662], [0.168, 0.674], [0.165, 0.682], [0.162, 0.691], [0.160, 0.696],
  [0.157, 0.703], [0.153, 0.709], [0.150, 0.716], [0.148, 0.721], [0.145, 0.726],
  [0.143, 0.731], [0.143, 0.734], [0.142, 0.738], [0.142, 0.739], [0.142, 0.741],
  [0.142, 0.739], [0.150, 0.733], [0.163, 0.723], [0.178, 0.709], [0.195, 0.696],
  [0.213, 0.681], [0.235, 0.664], [0.257, 0.644], [0.280, 0.624], [0.305, 0.604],
  [0.328, 0.584], [0.353, 0.561], [0.380, 0.539], [0.407, 0.517], [0.432, 0.496],
  [0.458, 0.476], [0.483, 0.454], [0.508, 0.436], [0.533, 0.416], [0.555, 0.398],
  [0.578, 0.379], [0.598, 0.361], [0.618, 0.343], [0.638, 0.326], [0.657, 0.311],
  [0.675, 0.297], [0.690, 0.286], [0.703, 0.274], [0.717, 0.264], [0.728, 0.256],
  [0.738, 0.247], [0.748, 0.241], [0.753, 0.237], [0.758, 0.234], [0.762, 0.233],
  [0.763, 0.233], [0.763, 0.234], [0.763, 0.236], [0.763, 0.237], [0.763, 0.242],
  [0.763, 0.247], [0.760, 0.254], [0.753, 0.264], [0.742, 0.278], [0.728, 0.289],
  [0.713, 0.302], [0.700, 0.319], [0.682, 0.336], [0.663, 0.354], [0.645, 0.372],
  [0.627, 0.393], [0.607, 0.412], [0.588, 0.432], [0.568, 0.451], [0.550, 0.472],
  [0.532, 0.492], [0.513, 0.512], [0.495, 0.534], [0.477, 0.554], [0.458, 0.576],
  [0.440, 0.598], [0.423, 0.618], [0.405, 0.636], [0.390, 0.656], [0.377, 0.672],
  [0.363, 0.691], [0.352, 0.706], [0.340, 0.721], [0.330, 0.736], [0.322, 0.748],
  [0.315, 0.757], [0.310, 0.767], [0.305, 0.776], [0.302, 0.782], [0.302, 0.787],
  [0.300, 0.791], [0.300, 0.794], [0.298, 0.796], [0.298, 0.797], [0.300, 0.797],
  [0.300, 0.797], [0.302, 0.797], [0.305, 0.797], [0.312, 0.794], [0.320, 0.789],
  [0.332, 0.781], [0.343, 0.771], [0.357, 0.761], [0.372, 0.749], [0.390, 0.736],
  [0.408, 0.721], [0.428, 0.704], [0.448, 0.686], [0.470, 0.669], [0.493, 0.651],
  [0.515, 0.636], [0.537, 0.621], [0.557, 0.606], [0.578, 0.589], [0.597, 0.574],
  [0.615, 0.561], [0.632, 0.547], [0.648, 0.536], [0.665, 0.524], [0.678, 0.514],
  [0.692, 0.506], [0.703, 0.496], [0.712, 0.489], [0.718, 0.484], [0.725, 0.479],
  [0.730, 0.476], [0.733, 0.472], [0.737, 0.469], [0.738, 0.468], [0.740, 0.468],
  [0.742, 0.468], [0.743, 0.468], [0.743, 0.469], [0.743, 0.471], [0.743, 0.472],
  [0.743, 0.476], [0.740, 0.481], [0.737, 0.487], [0.732, 0.496], [0.725, 0.504],
  [0.715, 0.516], [0.707, 0.527], [0.697, 0.541], [0.685, 0.554], [0.673, 0.569],
  [0.662, 0.583], [0.648, 0.599], [0.635, 0.616], [0.620, 0.632], [0.607, 0.651],
  [0.592, 0.667], [0.577, 0.686], [0.563, 0.703], [0.550, 0.719], [0.538, 0.738],
  [0.527, 0.754], [0.515, 0.769], [0.505, 0.784], [0.497, 0.799], [0.488, 0.811],
  [0.482, 0.823], [0.473, 0.834], [0.468, 0.843], [0.463, 0.851], [0.462, 0.856],
  [0.458, 0.861], [0.457, 0.864], [0.457, 0.868], [0.457, 0.869], [0.458, 0.869],
  [0.458, 0.868], [0.460, 0.868], [0.462, 0.868], [0.465, 0.866], [0.472, 0.861],
  [0.482, 0.856], [0.495, 0.846], [0.507, 0.838], [0.518, 0.828], [0.532, 0.818],
  [0.548, 0.807], [0.565, 0.794], [0.582, 0.781], [0.600, 0.769], [0.617, 0.756],
  [0.633, 0.743], [0.650, 0.731], [0.667, 0.719], [0.682, 0.708], [0.697, 0.698],
  [0.712, 0.688], [0.725, 0.677], [0.737, 0.667], [0.750, 0.657], [0.760, 0.649],
  [0.770, 0.642], [0.778, 0.634], [0.785, 0.629], [0.792, 0.624], [0.795, 0.621],
  [0.798, 0.619], [0.802, 0.616], [0.803, 0.614], [0.805, 0.613], [0.805, 0.611],
  [0.807, 0.611], [0.807, 0.611], [0.807, 0.613], [0.805, 0.614], [0.805, 0.616],
  [0.805, 0.621], [0.805, 0.623], [0.805, 0.627], [0.803, 0.631], [0.800, 0.636],
  [0.797, 0.641], [0.793, 0.647], [0.788, 0.656], [0.782, 0.666], [0.777, 0.674],
  [0.772, 0.682], [0.767, 0.691], [0.760, 0.701], [0.755, 0.711], [0.750, 0.719],
  [0.745, 0.728], [0.740, 0.736], [0.735, 0.744], [0.732, 0.752], [0.728, 0.759],
  [0.725, 0.766], [0.723, 0.772], [0.722, 0.777], [0.718, 0.784], [0.718, 0.789],
  [0.717, 0.796], [0.713, 0.801], [0.713, 0.806], [0.712, 0.813], [0.708, 0.816],
  [0.707, 0.821], [0.707, 0.826], [0.703, 0.831], [0.702, 0.836], [0.700, 0.839],
  [0.698, 0.841], [0.698, 0.844], [0.697, 0.846], [0.697, 0.848], [0.695, 0.848],
  [0.695, 0.849], [0.693, 0.851], [0.693, 0.853], [0.692, 0.853], [0.692, 0.854],
  [0.692, 0.856], [0.692, 0.859], [0.690, 0.861], [0.690, 0.863], [0.690, 0.864],
  [0.688, 0.868], [0.687, 0.869], [0.685, 0.873], [0.683, 0.874], [0.682, 0.877],
  [0.682, 0.879], [0.680, 0.881], [0.678, 0.882], [0.678, 0.882], [0.678, 0.884],
  [0.677, 0.884], [0.677, 0.887], [0.675, 0.889], [0.675, 0.891], [0.673, 0.891],
  [0.673, 0.892], [0.673, 0.892], [0.675, 0.892], [0.677, 0.892], [0.678, 0.892],
  [0.678, 0.891], [0.680, 0.891], [0.682, 0.889], [0.683, 0.889], [0.685, 0.887],
  [0.687, 0.884], [0.688, 0.882], [0.690, 0.881], [0.693, 0.877], [0.698, 0.874],
  [0.703, 0.869], [0.708, 0.864], [0.715, 0.859], [0.722, 0.854], [0.730, 0.848],
  [0.740, 0.839], [0.752, 0.831], [0.762, 0.823], [0.775, 0.813], [0.785, 0.802],
  [0.797, 0.792], [0.805, 0.784], [0.812, 0.777], [0.817, 0.771], [0.820, 0.769],
  [0.820, 0.767], [0.822, 0.767], [0.820, 0.766], [0.820, 0.767], [0.820, 0.766],
  [0.818, 0.764]
]

def filter_points(path, min_dist, drawing_size):
    """점 간의 거리가 min_dist보다 짧으면 제거하는 함수"""
    if not path:
        return []
    filtered = [path[0]]
    for i in range(1, len(path)):
        dx = (path[i]['x'] - filtered[-1]['x']) * drawing_size
        dy = (path[i]['y'] - filtered[-1]['y']) * drawing_size
        dist = math.sqrt(dx**2 + dy**2) 
        if dist >= min_dist:
            filtered.append(path[i])
    return filtered

def custom_drizzle(flat_data):
    """액션 서버로부터 받은 숫자 배열로 커스텀 소스 뿌리기"""
    from DSR_ROBOT2 import get_current_posx, movel, posx, wait, DR_BASE
    
    MIN_DISTANCE = 5.0    
    DRAWING_SIZE = 91.0   
    # Z_PRESS_DEPTH = 50.0  
    VELOCITY = 60
    ACC = 80
    
    # 데이터 복원
    raw_path = []
    for i in range(0, len(flat_data), 2):
        raw_path.append({'x': flat_data[i], 'y': flat_data[i+1]})
    
    filtered_path = filter_points(raw_path, MIN_DISTANCE, DRAWING_SIZE)

    if not filtered_path:
        print("   >>> ❌ 그릴 좌표가 없습니다. 그리기를 취소합니다.", flush=True)
        return

    try:
        response = get_current_posx(ref=DR_BASE)
        if isinstance(response, tuple): current_pos = response[0]
        else: current_pos = response
        bx, by, bz, ba, bb, bc = current_pos
    except Exception as e:
        print(f"   >>> ❌ [Error] 현재 위치를 읽을 수 없습니다: {e}", flush=True)
        return

    #########################################################################
    # radius=15.0 : blend radius (연속 궤적 반경) -> radius 값 클수록 소스 이동 반경 smooth화
    # 2.0은 너무 적으므로 10<= radius <= 20 내 반경이 적절함
    #########################################################################
    # 경로 따라 그리기
    for i, pt in enumerate(filtered_path):
        tx = bx + (pt['x'] * DRAWING_SIZE)
        ty = by - (pt['y'] * DRAWING_SIZE)

        if i == 0:
            movel(posx([tx, ty, bz, ba, bb, bc]), vel=VELOCITY, acc=ACC, ref=DR_BASE)
            wait(0.2)
        else:
            target_pos = posx([tx, ty, bz, ba, bb, bc])
            if i < len(filtered_path) - 1:
                movel(target_pos, vel=VELOCITY, acc=ACC, ref=DR_BASE)   # default radius=2.0
            else:
                movel(target_pos, vel=VELOCITY, acc=ACC, ref=DR_BASE)

    wait(0.2)
    last_pt = filtered_path[-1]
    last_tx = bx + (last_pt['x'] * DRAWING_SIZE)
    last_ty = by - (last_pt['y'] * DRAWING_SIZE)
    
    # 다 그리고 위로 살짝 들기 (이후 고속 턴을 위해 sleep은 아주 짧게!)
    # movel(posx([last_tx, last_ty, bz + 50, ba, bb, bc]), vel=VELOCITY, acc=ACC, ref=DR_BASE)
    time.sleep(0.1) 

def draw_default_logo():
    """웹소켓 경로가 없을 때, 내장된 기본 도안(로고)을 그리는 함수"""
    print("   >>> [Module] 커스텀 데이터가 없어 '기본 로고 도안'을 그립니다!", flush=True)
    flat_data = []
    # 2차원 리스트를 1차원 리스트로 쭉 폅니다.
    for pt in DEFAULT_DRAWING_COORDS:
        flat_data.append(pt[0])
        flat_data.append(pt[1])
    
    # 만들어진 기본 데이터를 기존 함수로 넘겨서 똑같이 그려지게 만듭니다!
    custom_drizzle(flat_data)